name: Get WordPress refresh token (safe)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  token:
    runs-on: ubuntu-latest
    steps:
      - name: Exchange code and save WP_REFRESH_TOKEN secret (no token in logs)
        env:
          WP_CLIENT_SECRET: ${{ secrets.WP_CLIENT_SECRET }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          CODE="PRQWzJZad3"

          RESP="$(curl -sS -X POST "https://public-api.wordpress.com/oauth2/token" \
            --data-urlencode "client_id=133140" \
            --data-urlencode "client_secret=${WP_CLIENT_SECRET}" \
            --data-urlencode "redirect_uri=https://mikloshetzer-sketch.github.io/balkan-security-map/" \
            --data-urlencode "code=${CODE}" \
            --data-urlencode "grant_type=authorization_code")"

          REFRESH="$(python3 - <<PY
import json, sys
resp = json.loads("""$RESP""")
rt = resp.get("refresh_token")
if not rt:
    print("NO_REFRESH_TOKEN")
    sys.exit(2)
print(rt)
PY
          )"

          # Save as repo secret without printing it
          gh secret set WP_REFRESH_TOKEN --body "$REFRESH"
          echo "OK: WP_REFRESH_TOKEN saved"

