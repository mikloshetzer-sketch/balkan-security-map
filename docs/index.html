<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Balk√°n Biztons√°gi Monitor ‚Äì t√©rk√©p</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card-bg: rgba(255,255,255,0.94);
      --shadow: 0 8px 28px rgba(0,0,0,0.14);
      --border: 1px solid rgba(0,0,0,0.08);
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --safe-top: max(env(safe-area-inset-top), 8px);
      --safe-right: max(env(safe-area-inset-right), 8px);
      --safe-left: max(env(safe-area-inset-left), 8px);
      --safe-bottom: max(env(safe-area-inset-bottom), 8px);
    }
    html, body { height: 100%; margin:0; font-family: var(--font); }
    #map { height: 100vh; width: 100vw; }

    /* ===== Alert banner ===== */
    .alert-banner{
      position:fixed; top:0; left:0; right:0; z-index:2000;
      display:none; padding:10px 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.18);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(6px);
    }
    .alert-banner .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width: 1200px; margin:0 auto;
    }
    .alert-banner .left{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .alert-banner .tag{
      display:inline-block; padding:2px 10px; border-radius:999px;
      background:#f2f2f2; font-size:12px; font-weight:700;
    }
    .alert-banner .title{ font-size:13px; font-weight:800; }
    .alert-banner .text{ font-size:13px; color:#222; }
    .alert-banner button{
      border:0; border-radius:10px; padding:6px 10px; cursor:pointer;
      background:#f2f2f2; font-size:12px;
    }
    .alert-banner.info   { background: rgba(247,251,255,0.96); }
    .alert-banner.watch  { background: rgba(251,251,247,0.96); }
    .alert-banner.medium { background: rgba(255,249,242,0.96); }
    .alert-banner.high   { background: rgba(255,243,243,0.96); }

    /* ===== Floating docks ===== */
    .dock{
      position:absolute;
      z-index: 1200;
      background: var(--card-bg);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      overflow: hidden;
    }
    .dock.top-left { top: calc(var(--safe-top) + 50px); left: calc(var(--safe-left) + 12px); }
    .dock.top-right { top: calc(var(--safe-top) + 50px); right: calc(var(--safe-right) + 12px); }
    .dock.bottom-right { right: calc(var(--safe-right) + 12px); bottom: calc(var(--safe-bottom) + 12px); }

    .dock .hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      background: rgba(250,250,250,0.95);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .dock .hd .title{
      font-size: 13px; font-weight: 800; color:#111;
      display:flex; align-items:center; gap:8px;
    }
    .dock .hd .meta{
      font-size: 12px; color:#555; font-weight: 500;
    }
    .dock .btn{
      border: 0;
      background: #f2f2f2;
      border-radius: 10px;
      padding: 6px 9px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .dock .body{ padding: 10px 10px; }
    .dock.collapsed .body{ display:none; }
    .dock .badge{
      display:inline-block; padding:2px 8px; border-radius:999px;
      background:#f2f2f2; font-size:12px; margin-right:6px;
    }

    .small { font-size:12px; color:#444; line-height:1.3; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .section{ margin: 10px 0; padding: 10px; background:#fafafa; border: 1px solid #eee; border-radius: 12px; }
    .section h3{ margin:0 0 6px; font-size:12px; font-weight:800; color:#111; }
    .section .meta{ margin:0 0 8px; font-size:12px; color:#666; }
    .section ul{ margin:0; padding-left: 18px; }
    .section li{ font-size:12px; color:#333; margin:4px 0; }
    details summary{ cursor:pointer; font-size:12px; color:#111; font-weight: 800; }
    details .muted{ color:#666; font-size:12px; margin-top:6px; }

    .layers .rowCk{ display:flex; gap:8px; align-items:center; margin:8px 0; }
    .layers label{ font-size: 12px; color:#222; }
    .layers input{ transform: translateY(1px); }

    .filters {
      margin-top: 10px;
      padding: 10px;
      border: 1px dashed rgba(0,0,0,0.18);
      border-radius: 12px;
      background: rgba(255,255,255,0.72);
    }
    .filters .row {
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
      margin-top: 8px;
    }
    .filters .btnSm {
      cursor:pointer;
      border: 1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .filters .btnSm.on {
      border-color: rgba(0,0,0,0.35);
      font-weight: 800;
    }

    .hotlist{ list-style:none; padding:0; margin:0; max-height: 240px; overflow:auto; }
    .hotitem{
      display:flex; justify-content:space-between; gap:10px;
      padding:7px 8px; border-radius: 10px; cursor:pointer;
    }
    .hotitem:hover{ background:#f2f2f2; }
    .place{ font-size:12px; font-weight:700; color:#111; }
    .sub{ font-size:12px; color:#555; }

    .situation{ width: min(560px, calc(100vw - 24px)); }
    .layers{ width: 300px; }
    .hotspots{ width: 340px; }

    /* ===== Legend ===== */
    .legend{
      background: rgba(255,255,255,0.92);
      padding: 10px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      font-family: var(--font);
      font-size: 12px;
      line-height: 1.15;
      width: 210px;
      max-height: 240px;
      overflow: auto;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin: 4px 0; }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.25);
      display:inline-block;
      flex: 0 0 10px;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 720px){
      .dock.top-left{ top: calc(var(--safe-top) + 50px); left: calc(var(--safe-left) + 10px); right: auto; }
      .situation{ width: auto; }

      #dockSituation .hd{ padding: 8px 8px; border-bottom: 0; }
      #dockSituation .hd .meta{ display:none; }
      #dockSituation.collapsed .hd .title{ display:none; }
      #dockSituation.collapsed .hd{ background: var(--card-bg); }
      #dockSituation.collapsed .btn{
        padding: 8px 10px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }

      #dockSituation:not(.collapsed){ left: 10px; right: 10px; width: auto; }
      #dockSituation:not(.collapsed) .hd .title{ display:flex; }
      #dockSituation:not(.collapsed) .hd .meta{ display:block; }

      .dock.top-right{
        top: auto;
        right: auto;
        left: calc(var(--safe-left) + 10px);
        bottom: calc(var(--safe-bottom) + 12px);
        width: auto;
      }
      .layers{ width: auto; }

      .dock.bottom-right{
        right: calc(var(--safe-right) + 10px);
        left: auto;
        bottom: calc(var(--safe-bottom) + 12px);
        width: auto;
      }
      .hotspots{ width: auto; }
      .hotlist{ max-height: 160px; }

      .legend{
        width: 170px;
        max-height: 160px;
        padding: 8px;
        margin-bottom: calc(var(--safe-bottom) + 4px);
      }
      .leaflet-control-zoom{
        margin-top: calc(var(--safe-top) + 56px) !important;
      }
    }
  </style>
</head>

<body>
  <div class="alert-banner" id="alertBanner" role="status" aria-live="polite">
    <div class="row">
      <div class="left">
        <span class="tag" id="alertTag">RIASZT√ÅS</span>
        <span class="title" id="alertTitle">‚Äî</span>
        <span class="text" id="alertText">‚Äî</span>
      </div>
      <button id="alertClose" type="button">Bez√°r</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- Situation -->
  <div class="dock top-left situation collapsed" id="dockSituation">
    <div class="hd">
      <div>
        <div class="title">Balk√°n ‚Äì helyzetk√©p</div>
        <div class="meta" id="metaLine">Bet√∂lt√©s...</div>
      </div>
      <button class="btn" id="btnSituation">Kinyit</button>
    </div>
    <div class="body">
      <div class="section">
        <h3 id="sumTitle">Napi kivonat</h3>
        <div class="meta" id="sumTime">‚Äî</div>
        <ul id="sumList"><li>Bet√∂lt√©s...</li></ul>
      </div>

      <details class="section" open>
        <summary>Heti kivonat (7 nap)</summary>
        <div class="meta" id="weekTime" style="margin-top:6px;">‚Äî</div>
        <ul id="weekList"><li>Bet√∂lt√©s...</li></ul>
        <div id="weekExamples" class="muted"></div>
      </details>

      <details class="section">
        <summary>Early signals (elemz≈ë m√≥d)</summary>
        <div class="meta" id="earlyTime" style="margin-top:6px;">‚Äî</div>
        <ul id="earlyList"><li class="muted">M√©g nincs el√©g minta.</li></ul>
        <div class="muted">Megjelen√≠t√©shez kapcsold be az EARLY r√©teget.</div>
      </details>

      <div class="filters">
        <div class="small">
          <b>Mai esem√©nyek</b> Budapest id≈ëz√≥n√°val:
          <span class="mono" id="todayBud">‚Äî</span>
        </div>
        <div class="row">
          <button class="btnSm" id="btnTodayNews" type="button">Mai h√≠rek</button>
          <button class="btnSm" id="btnTodayAlerts" type="button">Mai riaszt√°sok</button>
          <button class="btnSm on" id="btnReset7d" type="button">Vissza 7 napra</button>
        </div>
        <div class="small" style="margin-top:6px;">
          Mai h√≠rek = GDELT (GEO + LINKES) ‚Ä¢ Mai riaszt√°sok = USGS + GDACS
        </div>
      </div>

      <div class="small" style="margin-top:10px;">
        Mobilon a ‚ÄûHelyzetk√©p‚Äù alapb√≥l csak gomb, hogy ne takarja a t√©rk√©pet.
      </div>
    </div>
  </div>

  <!-- Layers -->
  <div class="dock top-right layers collapsed" id="dockLayers">
    <div class="hd">
      <div class="title">R√©tegek</div>
      <button class="btn" id="btnLayers">Kinyit</button>
    </div>
    <div class="body">
      <div class="rowCk">
        <input type="checkbox" id="layerBorders" checked>
        <label for="layerBorders"><span class="badge">HAT√ÅR</span>kont√∫r</label>
      </div>
      <div class="rowCk">
        <input type="checkbox" id="layerHot" checked>
        <label for="layerHot"><span class="badge">HOTSPOT</span>heat</label>
      </div>
      <div class="rowCk">
        <input type="checkbox" id="layerEarly">
        <label for="layerEarly"><span class="badge">EARLY</span>elemz≈ë</label>
      </div>

      <div class="rowCk">
        <input type="checkbox" id="layerGdelt" checked>
        <label for="layerGdelt"><span class="badge">GDELT</span>h√≠rek</label>
      </div>
      <div class="rowCk">
        <input type="checkbox" id="layerGdeltLinked">
        <label for="layerGdeltLinked"><span class="badge">GDELT+</span>linkes</label>
      </div>

      <div class="rowCk">
        <input type="checkbox" id="layerUsgs">
        <label for="layerUsgs"><span class="badge">USGS</span>reng√©sek</label>
      </div>
      <div class="rowCk">
        <input type="checkbox" id="layerGdacs">
        <label for="layerGdacs"><span class="badge">GDACS</span>riaszt√°s</label>
      </div>

      <div class="small" style="margin-top:8px;">
        <b>Megjelen√≠t√©s:</b> GDELT kateg√≥ria-sz√≠nez√©s ‚Ä¢ USGS/GDACS ‚Äúfrissess√©g‚Äù alap√∫.
      </div>
    </div>
  </div>

  <!-- Hotspots -->
  <div class="dock bottom-right hotspots collapsed" id="dockHotspots">
    <div class="hd">
      <div class="title">Top hotspotok</div>
      <button class="btn" id="btnHotspots">Kinyit</button>
    </div>
    <div class="body">
      <ol class="hotlist" id="hotList"></ol>
      <div class="small" style="margin-top:8px;">Kattints a sorra ‚Üí zoom.</div>
    </div>
  </div>

  <script>
    // ===== PATH (ha m√°shol van, itt el√©g √°t√≠rni) =====
    const DATA = "./data";

    // ===== CATEGORY styles (CEE-hez hasonl√≥) =====
    const CAT_STYLE = {
      protest: { radius: 6, fillOpacity: 0.55 },
      border: { radius: 6, fillOpacity: 0.55 },
      police: { radius: 6, fillOpacity: 0.55 },
      military: { radius: 6, fillOpacity: 0.55 },
      drone: { radius: 6, fillOpacity: 0.55 },
      cyber: { radius: 6, fillOpacity: 0.55 },
      energy: { radius: 6, fillOpacity: 0.55 },
      infrastructure: { radius: 6, fillOpacity: 0.55 },
      security_politics: { radius: 6, fillOpacity: 0.55 },
      violence: { radius: 7, fillOpacity: 0.60 },
      natural: { radius: 6, fillOpacity: 0.50 },
      other: { radius: 6, fillOpacity: 0.45 }
    };

    function humanCat(cat){
      const m = {
        protest: "t√ºntet√©s/er≈ëszak",
        border: "hat√°r/migr√°ci√≥",
        police: "rend≈ërs√©g/jog",
        military: "katonai",
        drone: "dr√≥n/UAV",
        cyber: "kiber/dezinform√°ci√≥",
        energy: "energia/ell√°t√°s",
        infrastructure: "infrastrukt√∫ra",
        security_politics: "security politics",
        violence: "er≈ëszak",
        natural: "term√©szeti",
        other: "egy√©b"
      };
      return m[cat] || cat || "egy√©b";
    }

    function catColor(cat){
      return (cat === "cyber") ? "#6f42c1" :
             (cat === "energy") ? "#d39e00" :
             (cat === "border") ? "#0c8599" :
             (cat === "protest") ? "#c92a2a" :
             (cat === "military") ? "#2f9e44" :
             (cat === "drone") ? "#364fc7" :
             (cat === "police") ? "#343a40" :
             (cat === "security_politics") ? "#5c7cfa" :
             (cat === "natural") ? "#099268" :
             (cat === "violence") ? "#a61e4d" : "#868e96";
    }

    // ===== Map =====
    const map = L.map('map', { zoomControl: true, preferCanvas: true }).setView([44.2, 20.6], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ===== Utils =====
    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function fmtBudapest(isoUtcString) {
      if (!isoUtcString) return null;
      const d = new Date(isoUtcString);
      if (isNaN(d.getTime())) return null;
      const bud = new Intl.DateTimeFormat('hu-HU', {
        timeZone: 'Europe/Budapest',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      }).format(d);
      const utc = new Intl.DateTimeFormat('hu-HU', {
        timeZone: 'UTC',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      }).format(d);
      return { bud, utc };
    }

    function parseEventTime(props) {
      const t = props?.time || props?.datetime || props?.date;
      if (!t) return null;
      const d = new Date(t);
      return isNaN(d.getTime()) ? null : d;
    }

    function ymdInTZ(dateObj, tz){
      const fmt = new Intl.DateTimeFormat("en-CA", { timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit" });
      return fmt.format(dateObj); // YYYY-MM-DD
    }

    function isTodayBudapest(timeOrDateString){
      if(!timeOrDateString) return false;
      let d;
      try { d = new Date(timeOrDateString); } catch { return false; }
      if(isNaN(d.getTime())) return false;
      const todayBud = ymdInTZ(new Date(), "Europe/Budapest");
      const evBud = ymdInTZ(d, "Europe/Budapest");
      return evBud === todayBud;
    }

    // ===== Styles: USGS/GDACS recency =====
    function eventRecencyStyle(sourceName, props) {
      const d = parseEventTime(props);
      const now = new Date();
      let ageDays = null;
      if (d) ageDays = (now.getTime() - d.getTime()) / (1000*60*60*24);

      let color = "#3b82f6";
      let fillColor = "#3b82f6";
      let opacity = 0.35;
      let fillOpacity = 0.22;
      let radius = 6;
      let weight = 1;

      if (sourceName === "USGS") radius = 7;
      if (sourceName === "GDACS") radius = 8;
      if (sourceName === "GDELT") radius = 6;

      if (ageDays !== null) {
        if (ageDays <= 1) {
          color = "#b91c1c"; fillColor = "#ef4444";
          opacity = 0.75; fillOpacity = 0.45; weight = 2; radius += 2;
        } else if (ageDays <= 3) {
          color = "#c2410c"; fillColor = "#f97316";
          opacity = 0.65; fillOpacity = 0.35; weight = 2; radius += 1;
        } else if (ageDays <= 7) {
          color = "#a16207"; fillColor = "#f59e0b";
          opacity = 0.55; fillOpacity = 0.28; weight = 1.5;
        } else {
          color = "#6b7280"; fillColor = "#9ca3af";
          opacity = 0.30; fillOpacity = 0.16; weight = 1;
        }
      }
      return { radius, weight, color, fillColor, opacity, fillOpacity, ageDays };
    }

    // ===== Popup (CEE-szer≈±: category + search_url fallback + linked sources) =====
    function makePopup(props) {
      const title = props.title ? `<div style="margin-bottom:6px;"><b>${esc(props.title)}</b></div>` : '';
      const t = props.time ? `<div><b>Id≈ë:</b> ${esc(props.time)}</div>` : '';
      const place = props.place ? `<div><b>Hely:</b> ${esc(props.place)}</div>` : '';
      const typ = props.type ? `<div><b>T√≠pus:</b> ${esc(props.type)}</div>` : '';
      const domain = props.domain ? `<div><b>Forr√°s:</b> ${esc(props.domain)}</div>` : '';

      const catRaw = props.category || props.gdelt_bucket || null;
      const cat = catRaw ? `<div><b>Kateg√≥ria:</b> ${esc(humanCat(catRaw))}</div>` : '';

      const mag = (props.mag !== undefined && props.mag !== null) ? `<div><b>Magnit√∫d√≥:</b> ${esc(props.mag)}</div>` : '';

      const link = props.url || props.search_url;
      const url = link ? `<div style="margin-top:6px;">üîó <a href="${esc(link)}" target="_blank" rel="noopener">Forr√°s / keres√©s</a></div>` : '';

      let sources = '';
      if (Array.isArray(props.sources) && props.sources.length) {
        const items = props.sources.slice(0, 8)
          .map((u,i) => `<li><a href="${esc(u)}" target="_blank" rel="noopener">Forr√°s #${i+1}</a></li>`)
          .join('');
        sources = `<div style="margin-top:6px;"><b>Forr√°sok:</b><ul style="margin:6px 0 0; padding-left:18px;">${items}</ul></div>`;
      }

      const kind = props.kind ? `<div class="small" style="margin-top:6px;color:#666;">kind: ${esc(props.kind)}</div>` : '';

      return `${title}${cat}${t}${place}${typ}${mag}${domain}${url}${sources}${kind}`;
    }

    // ===== Hotspot heat-like =====
    function hotspotStyle(score, maxScore) {
      const s = Math.max(0, Number(score) || 0);
      const m = Math.max(0.001, Number(maxScore) || 0.001);
      const t = Math.min(1, s / m);
      const radius = 6 + t * 16;
      const fillOpacity = 0.08 + t * 0.37;
      const opacity = 0.18 + t * 0.52;
      return { radius, weight: 1, fillOpacity, opacity, color:"#2563eb", fillColor:"#60a5fa" };
    }

    function earlyStyle(escalation) {
      const e = Math.max(0, Math.min(100, Number(escalation) || 0));
      const t = e / 100;
      const radius = 5 + t * 10;
      const fillOpacity = 0.06 + t * 0.22;
      const opacity = 0.25 + t * 0.35;
      return { radius, weight: 1, fillOpacity, opacity, color:"#7c3aed", fillColor:"#a78bfa" };
    }

    // ===== Data containers for filtering (7d vs today) =====
    const DATASETS = {
      gdelt: null,
      gdeltLinked: null,
      gdacs: null,
      usgs: null
    };
    const FILTERS = { newsToday: false, alertsToday: false };

    function applyFilters(){
      // GDELT (news)
      if (DATASETS.gdelt && layers.gdelt){
        const feats = DATASETS.gdelt.features || [];
        const keep = FILTERS.newsToday
          ? feats.filter(f => isTodayBudapest((f.properties||{}).time || (f.properties||{}).date))
          : feats;
        layers.gdelt.clearLayers();
        layers.gdelt.addData({ type:"FeatureCollection", features: keep });
      }
      if (DATASETS.gdeltLinked && layers.gdeltLinked){
        const feats = DATASETS.gdeltLinked.features || [];
        const keep = FILTERS.newsToday
          ? feats.filter(f => isTodayBudapest((f.properties||{}).time || (f.properties||{}).date))
          : feats;
        layers.gdeltLinked.clearLayers();
        layers.gdeltLinked.addData({ type:"FeatureCollection", features: keep });
      }

      // Alerts (GDACS + USGS)
      if (DATASETS.gdacs && layers.gdacs){
        const feats = DATASETS.gdacs.features || [];
        const keep = FILTERS.alertsToday
          ? feats.filter(f => isTodayBudapest((f.properties||{}).time || (f.properties||{}).date))
          : feats;
        layers.gdacs.clearLayers();
        layers.gdacs.addData({ type:"FeatureCollection", features: keep });
      }
      if (DATASETS.usgs && layers.usgs){
        const feats = DATASETS.usgs.features || [];
        const keep = FILTERS.alertsToday
          ? feats.filter(f => isTodayBudapest((f.properties||{}).time || (f.properties||{}).date))
          : feats;
        layers.usgs.clearLayers();
        layers.usgs.addData({ type:"FeatureCollection", features: keep });
      }

      // UI button states
      document.getElementById("btnTodayNews").classList.toggle("on", FILTERS.newsToday);
      document.getElementById("btnTodayAlerts").classList.toggle("on", FILTERS.alertsToday);
      document.getElementById("btnReset7d").classList.toggle("on", (!FILTERS.newsToday && !FILTERS.alertsToday));
    }

    // ===== Leaflet layer constructors =====
    function gdeltPointToLayer(feature, latlng){
      const p = feature.properties || {};
      const cat = p.category || p.gdelt_bucket || "other";
      const st = CAT_STYLE[cat] || CAT_STYLE.other;

      // frissess√©g csak kis r√°seg√≠t√©s
      const rec = eventRecencyStyle("GDELT", p);
      const isFresh = (rec.ageDays !== null && rec.ageDays <= 3);

      return L.circleMarker(latlng, {
        radius: st.radius + (isFresh ? 2 : 0),
        weight: isFresh ? 2 : 1,
        color: isFresh ? "#111" : "#333",
        opacity: isFresh ? 0.75 : 0.45,
        fillColor: catColor(cat),
        fillOpacity: st.fillOpacity
      });
    }

    function genericRecencyPointToLayer(sourceName){
      return (feature, latlng) => {
        const p = feature.properties || {};
        const style = eventRecencyStyle(sourceName, p);
        return L.circleMarker(latlng, style);
      };
    }

    async function loadJson(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`Fetch failed: ${url} (${r.status})`);
      return await r.json();
    }

    async function loadBorders(url) {
      const gj = await loadJson(url);
      return L.geoJSON(gj, { style: () => ({ weight: 1.25, opacity: 0.6, fillOpacity: 0.0, color:"#2563eb" }) });
    }

    async function loadHotspotsHeat(url) {
      const gj = await loadJson(url);
      let maxScore = 0;
      for (const f of (gj.features || [])) {
        const s = Number((f.properties || {}).score) || 0;
        if (s > maxScore) maxScore = s;
      }
      return L.geoJSON(gj, {
        pointToLayer: (feature, latlng) => {
          const p = feature.properties || {};
          return L.circleMarker(latlng, hotspotStyle(p.score, maxScore));
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          const src = p.sources ? `GDELT:${p.sources.GDELT||0}, USGS:${p.sources.USGS||0}, GDACS:${p.sources.GDACS||0}` : '';
          const tr = p.trend_arrow ? ` ${p.trend_arrow}` : '';
          const ch = (p.change_pct === null || p.change_pct === undefined) ? 'n/a' : `${p.change_pct > 0 ? '+' : ''}${p.change_pct}%`;
          layer.bindPopup(
            `<div><b>Hotspot cell</b>${esc(tr)}</div>
             <div><b>Score:</b> ${esc(p.score)}</div>
             <div><b>7 napos v√°ltoz√°s:</b> ${esc(ch)}</div>
             <div><b>Count:</b> ${esc(p.count)}</div>
             <div class="mono">${esc(src)}</div>`
          );
        }
      });
    }

    async function loadEarly(url) {
      const gj = await loadJson(url);
      return L.geoJSON(gj, {
        pointToLayer: (feature, latlng) => {
          const p = feature.properties || {};
          return L.circleMarker(latlng, earlyStyle(p.escalation));
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          const zone = p.zone ? ` (z√≥na: ${esc(p.zone)} √ó${esc(p.zone_mult)})` : '';
          layer.bindPopup(
            `<div><b>EARLY signal</b> ‚ö†</div>
             <div><b>Escalation:</b> ${esc(p.escalation)} / 100</div>
             <div><b>Recent (48h):</b> ${esc(p.recent)} | <b>Baseline:</b> ${esc(p.baseline)} | <b>Ratio:</b> ${esc(p.ratio)}</div>
             <div><b>Terjed√©s:</b> szomsz√©d akt√≠v cell√°k: ${esc(p.neighbor_active)}${zone}</div>`
          );
        }
      });
    }

    // ===== Alert banner =====
    function renderAlertBanner(alert) {
      const banner = document.getElementById('alertBanner');
      if (!alert) {
        banner.style.display = 'none';
        banner.className = 'alert-banner';
        return;
      }
      const level = (alert.level || 'info').toLowerCase();
      banner.className = `alert-banner ${level}`;
      document.getElementById('alertTitle').textContent = alert.title || 'Riaszt√°s';
      document.getElementById('alertText').textContent = alert.text || '';
      document.getElementById('alertTag').textContent = 'RIASZT√ÅS';
      banner.style.display = 'block';
    }
    document.getElementById('alertClose').addEventListener('click', () => {
      document.getElementById('alertBanner').style.display = 'none';
    });

    // ===== Docks =====
    function setupDock(dockId, btnId, openText="Bez√°r", closedText="Kinyit") {
      const dock = document.getElementById(dockId);
      const btn = document.getElementById(btnId);
      const setBtn = () => btn.textContent = dock.classList.contains('collapsed') ? closedText : openText;
      btn.addEventListener('click', () => {
        dock.classList.toggle('collapsed');
        setBtn();
      });
      setBtn();
    }
    setupDock("dockSituation", "btnSituation");
    setupDock("dockLayers", "btnLayers");
    setupDock("dockHotspots", "btnHotspots");

    // ===== UI renderers =====
    function renderMeta(meta) {
      const t = fmtBudapest(meta?.generated_utc);
      const timeText = t ? `Friss√≠t√©s (Budapest): ${t.bud}` : `Friss√≠t√©s: ‚Äî`;
      const counts = meta?.counts || {};
      const gl = counts.gdelt_linked ?? 0;

      document.getElementById('metaLine').textContent =
        `${timeText} | hotspot cell√°k: ${counts.hotspot_cells ?? 0} | GDELT: ${counts.gdelt ?? 0} + linkes: ${gl}, USGS: ${counts.usgs ?? 0}, GDACS: ${counts.gdacs ?? 0}`;
    }

    function renderSummary(sum) {
      document.getElementById('sumTitle').textContent = sum?.headline || 'Napi kivonat';
      const t = fmtBudapest(sum?.generated_utc);
      document.getElementById('sumTime').textContent = t ? `Kivonat friss√≠t√©se (Budapest): ${t.bud}` : '‚Äî';
      renderAlertBanner(sum?.alert || null);

      const ul = document.getElementById('sumList');
      ul.innerHTML = '';
      const bullets = (sum?.bullets || []).slice(0, 10);
      if (!bullets.length) {
        ul.innerHTML = '<li>Nincs el√©rhet≈ë kivonat.</li>';
        return;
      }
      for (const b of bullets) {
        const li = document.createElement('li');
        li.textContent = b;
        ul.appendChild(li);
      }
    }

    function renderWeekly(w) {
      const t = fmtBudapest(w?.generated_utc);
      document.getElementById('weekTime').textContent = t ? `Kivonat friss√≠t√©se (Budapest): ${t.bud}` : '‚Äî';

      const ul = document.getElementById('weekList');
      ul.innerHTML = '';
      const bullets = (w?.bullets || []).slice(0, 10);
      if (!bullets.length) {
        ul.innerHTML = '<li>A heti kivonat m√©g gy≈±lik.</li>';
      } else {
        for (const b of bullets) {
          const li = document.createElement('li');
          li.textContent = b;
          ul.appendChild(li);
        }
      }

      const ex = document.getElementById('weekExamples');
      ex.innerHTML = '';
      const examples = (w?.examples || []).slice(0, 5);
      if (!examples.length) {
        ex.textContent = 'P√©lda esem√©nyek: m√©g nincs el√©g heti h√≠rc√≠m a list√°hoz.';
        return;
      }
      const wrap = document.createElement('div');
      wrap.className = 'small';
      wrap.textContent = 'P√©lda esem√©nyek:';
      ex.appendChild(wrap);

      const list = document.createElement('ul');
      list.style.margin = '6px 0 0';
      list.style.paddingLeft = '18px';
      for (const e of examples) {
        const li = document.createElement('li');
        const title = e.title || '(nincs c√≠m)';
        const url = e.url || '#';
        const dom = e.domain ? ` (${e.domain})` : '';
        li.innerHTML = `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(title)}</a><span class="small" style="color:#666">${esc(dom)}</span>`;
        list.appendChild(li);
      }
      ex.appendChild(list);
    }

    function renderEarlyList(payload) {
      const t = fmtBudapest(payload?.generated_utc);
      document.getElementById('earlyTime').textContent = t ? `Friss√≠t√©s (Budapest): ${t.bud}` : '‚Äî';

      const ul = document.getElementById('earlyList');
      ul.innerHTML = '';
      const top = (payload?.top || []).slice(0, 8);

      if (!top.length) {
        const li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'M√©g nincs el√©g gyorsul√°s/terjed√©s jelleg≈± minta (ez norm√°lis az els≈ë napokban).';
        ul.appendChild(li);
        return;
      }

      for (const e of top) {
        const li = document.createElement('li');
        const place = e.place || 'ismeretlen t√©rs√©g';
        const zone = e.zone ? ` | z√≥na: ${e.zone} √ó${e.zone_mult}` : '';
        li.textContent = `${place} ‚Äî escalation ${e.escalation}/100 | terjed√©s: ${e.neighbor_active}${zone}`;
        ul.appendChild(li);
      }
    }

    function renderHotList(items) {
      const ol = document.getElementById('hotList');
      ol.innerHTML = '';
      const top = (items || []).slice(0, 8);
      if (!top.length) {
        ol.innerHTML = '<li class="small">Nincs el√©g adat.</li>';
        return;
      }

      for (const it of top) {
        const li = document.createElement('li');
        li.className = 'hotitem';

        const place = it.place ? it.place : 'ismeretlen t√©rs√©g';
        const arrow = it.trend_arrow ? it.trend_arrow : '¬∑';
        const ch = (it.change_pct === null || it.change_pct === undefined) ? 'n/a' : `${it.change_pct > 0 ? '+' : ''}${it.change_pct}%`;

        li.innerHTML = `
          <div>
            <div class="place">${esc(place)} <span class="mono">${esc(arrow)}</span> <span class="mono">(${esc(ch)})</span></div>
            <div class="sub">${esc(`(${it.lat.toFixed(2)}, ${it.lon.toFixed(2)}) ‚Ä¢ db: ${it.count}`)}</div>
          </div>
          <div class="mono">S=${Number(it.score).toFixed(2)}</div>
        `;
        li.addEventListener('click', () => map.setView([it.lat, it.lon], 9));
        ol.appendChild(li);
      }
    }

    // ===== Layers (Leaflet objects) =====
    const layers = {
      borders: null,
      hot: null,
      early: null,
      gdelt: L.geoJSON(null, { pointToLayer: gdeltPointToLayer, onEachFeature: (f,l)=>l.bindPopup(makePopup(f.properties||{})) }),
      gdeltLinked: L.geoJSON(null, { pointToLayer: gdeltPointToLayer, onEachFeature: (f,l)=>l.bindPopup(makePopup(f.properties||{})) }),
      usgs: L.geoJSON(null, { pointToLayer: genericRecencyPointToLayer("USGS"), onEachFeature: (f,l)=>l.bindPopup(makePopup(f.properties||{})) }),
      gdacs: L.geoJSON(null, { pointToLayer: genericRecencyPointToLayer("GDACS"), onEachFeature: (f,l)=>l.bindPopup(makePopup(f.properties||{})) })
    };

    // ===== Legend control =====
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function(){
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div style="font-weight:800;margin-bottom:6px;">Jelmagyar√°zat (GDELT kateg√≥ri√°k)</div>
        ${[
          ["protest","T√ºntet√©s/er≈ëszak", catColor("protest")],
          ["border","Hat√°r/migr√°ci√≥", catColor("border")],
          ["police","Rend≈ërs√©g/jog", catColor("police")],
          ["military","Katonai", catColor("military")],
          ["drone","Dr√≥n/UAV", catColor("drone")],
          ["cyber","Kiber/dezinform√°ci√≥", catColor("cyber")],
          ["energy","Energia/ell√°t√°s", catColor("energy")],
          ["infrastructure","Infrastrukt√∫ra", catColor("infrastructure")],
          ["security_politics","Security politics", catColor("security_politics")],
          ["natural","Term√©szeti", catColor("natural")],
          ["other","Egy√©b", catColor("other")]
        ].map(([k,label,color]) =>
          `<div class="row"><span class="dot" style="background:${color}"></span><span>${esc(label)}</span></div>`
        ).join("")}
        <div style="margin-top:8px;" class="small">USGS/GDACS sz√≠n: frissess√©g (0‚Äì24h ‚Üí piros).</div>
      `;
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);
      return div;
    };
    legend.addTo(map);

    // ===== Init =====
    async function init() {
      // today label
      document.getElementById("todayBud").textContent = ymdInTZ(new Date(), "Europe/Budapest");

      // Load meta/summaries
      try { renderMeta(await loadJson(`${DATA}/meta.json`)); }
      catch { document.getElementById('metaLine').textContent = 'Meta bet√∂lt√©se nem siker√ºlt.'; }

      try { renderSummary(await loadJson(`${DATA}/summary.json`)); }
      catch { renderSummary({ headline: 'Napi kivonat', bullets: [], alert: null }); }

      try { renderWeekly(await loadJson(`${DATA}/weekly.json`)); }
      catch { renderWeekly({ bullets: [], examples: [] }); }

      try { renderEarlyList(await loadJson(`${DATA}/early.json`)); }
      catch { renderEarlyList({ top: [] }); }

      // Load borders/hot/early as real layers
      try { layers.borders = await loadBorders(`${DATA}/balkan_borders.geojson`); } catch {}
      try { layers.hot = await loadHotspotsHeat(`${DATA}/hotspots.geojson`); } catch {}
      try { layers.early = await loadEarly(`${DATA}/early.geojson`); } catch {}

      // Load datasets (for filtering) and set into Leaflet layers
      const [gdelt, gdeltLinked, usgs, gdacs] = await Promise.all([
        loadJson(`${DATA}/gdelt.geojson`).catch(()=>null),
        loadJson(`${DATA}/gdelt_linked.geojson`).catch(()=>null),
        loadJson(`${DATA}/usgs.geojson`).catch(()=>null),
        loadJson(`${DATA}/gdacs.geojson`).catch(()=>null),
      ]);

      if (gdelt) DATASETS.gdelt = gdelt;
      if (gdeltLinked) DATASETS.gdeltLinked = gdeltLinked;
      if (usgs) DATASETS.usgs = usgs;
      if (gdacs) DATASETS.gdacs = gdacs;

      // initial render of filterable layers
      applyFilters();

      // add non-filter layers data
      if (layers.borders) layers.borders.addTo(map);
      if (layers.hot) layers.hot.addTo(map);
      layers.gdelt.addTo(map); // default on

      // Hook layer checkboxes
      document.getElementById('layerBorders').addEventListener('change', (e) => {
        if (!layers.borders) return;
        e.target.checked ? map.addLayer(layers.borders) : map.removeLayer(layers.borders);
      });
      document.getElementById('layerHot').addEventListener('change', (e) => {
        if (!layers.hot) return;
        e.target.checked ? map.addLayer(layers.hot) : map.removeLayer(layers.hot);
      });
      document.getElementById('layerEarly').addEventListener('change', (e) => {
        if (!layers.early) return;
        e.target.checked ? map.addLayer(layers.early) : map.removeLayer(layers.early);
      });
      document.getElementById('layerGdelt').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(layers.gdelt) : map.removeLayer(layers.gdelt);
      });
      document.getElementById('layerGdeltLinked').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(layers.gdeltLinked) : map.removeLayer(layers.gdeltLinked);
      });
      document.getElementById('layerUsgs').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(layers.usgs) : map.removeLayer(layers.usgs);
      });
      document.getElementById('layerGdacs').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(layers.gdacs) : map.removeLayer(layers.gdacs);
      });

      // Filters
      document.getElementById("btnTodayNews").addEventListener("click", () => {
        FILTERS.newsToday = !FILTERS.newsToday;
        applyFilters();
      });
      document.getElementById("btnTodayAlerts").addEventListener("click", () => {
        FILTERS.alertsToday = !FILTERS.alertsToday;
        applyFilters();
      });
      document.getElementById("btnReset7d").addEventListener("click", () => {
        FILTERS.newsToday = false;
        FILTERS.alertsToday = false;
        applyFilters();
      });

      // Top hotspots list
      try {
        const top = await loadJson(`${DATA}/hotspots.json`);
        renderHotList(top.top || []);
      } catch {
        renderHotList([]);
      }
    }

    init().catch(err => {
      console.error(err);
      document.getElementById('metaLine').textContent = 'Hiba a bet√∂lt√©sben (l√°sd konzol).';
    });
  </script>
</body>
</html>
